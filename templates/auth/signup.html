{% extends 'base/auth_base.html' %}

{% block head %}
<style>
  .step-dot { height: 6px; flex: 1; margin: 0 4px; background: var(--input-border); border-radius: 10px; transition: 0.3s; }
  .step-dot.active { background: var(--brand-dark); }
  .form-step { display: none; }
  .form-step.active { display: block; animation: slideUp 0.4s ease; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .color-picker { border: 1px solid var(--input-border); border-radius: 16px; padding: 12px; background: #fff; box-shadow: 0 10px 24px rgba(11, 52, 61, 0.08); height: 100%; display: flex; flex-direction: column; }
  .color-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .color-preview { width: 100%; height: 18px; border-radius: 999px; border: 1px solid rgba(0, 0, 0, 0.08); box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6); }
  .color-preview-wrap { flex: 1; display: flex; flex-direction: column; gap: 8px; }
  .color-hex { width: 100%; border: 1px solid var(--input-border); border-radius: 10px; padding: 10px 12px; font-size: 13px; letter-spacing: 0.5px; text-transform: lowercase; }
  .color-hex:focus { outline: none; box-shadow: 0 0 0 3px rgba(11, 52, 61, 0.15); }
  .slider-label { display: flex; align-items: center; justify-content: space-between; font-size: 11px; color: #5b6b72; margin: 8px 0 4px; }
  .color-slider { width: 100%; appearance: none; height: 8px; border-radius: 999px; background: #e6edf0; outline: none; }
  .color-slider::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; border-radius: 999px; background: #fff; border: 1px solid rgba(0, 0, 0, 0.15); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.18); cursor: pointer; }
  .color-slider::-moz-range-thumb { width: 18px; height: 18px; border-radius: 999px; background: #fff; border: 1px solid rgba(0, 0, 0, 0.15); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.18); cursor: pointer; }
  .color-swatches { display: grid; grid-template-columns: repeat(10, 1fr); gap: 6px; margin-top: 12px; }
  .swatch { width: 100%; padding-top: 100%; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.08); cursor: pointer; }
  .swatch.active { outline: 2px solid rgba(11, 52, 61, 0.35); }
</style>
{% endblock %}

{% block content %}
<div class="auth-card">
    <div class="text-center mb-4">
      <h4 class="fw-bold" style="color: var(--brand-dark)">Create Account</h4>
      <p class="text-secondary small" id="step-text">Step 1: Account Security</p>
      {% if error %}
      <div class="alert alert-danger mt-2">{{ error }}</div>
      {% endif %}
    </div>

    <div class="d-flex mb-4">
      <div class="step-dot active" id="dot-1"></div>
      <div class="step-dot" id="dot-2"></div>
      <div class="step-dot" id="dot-3"></div>
    </div>

    <form method="POST" action="/signup" enctype="multipart/form-data">
      <div class="form-step active" id="step-1">
        <div class="mb-3">
          <label class="form-label">Email Address</label>
          <input type="email" name="email" class="form-control" placeholder="admin@neuronet.ai" required>
        </div>
        <div class="text-secondary small mb-3">We'll verify this email with a one-time code.</div>
        <button type="button" class="btn w-100 mt-3 py-3 text-white fw-bold" style="background: var(--brand-dark); border-radius:12px;" onclick="nextStep(2)">
          Continue <i class="fa-solid fa-arrow-right ms-2"></i>
        </button>
      </div>

      <div class="form-step" id="step-2">
        <div class="mb-3">
          <label class="form-label">Restaurant Name</label>
          <input type="text" name="establishment_name" class="form-control" placeholder="The Golden Bistro">
        </div>
        <div class="mb-4">
          <label class="form-label">Logo Upload</label>
          <input type="file" name="logo_file" class="form-control">
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-light flex-grow-1 py-3 fw-bold" onclick="nextStep(1)">Back</button>
          <button type="button" class="btn text-white flex-grow-1 py-3 fw-bold" style="background: var(--brand-dark)" onclick="nextStep(3)">Next</button>
        </div>
      </div>

      <div class="form-step" id="step-3">
        <div class="row mb-4">
          <div class="col-6">
            <label class="form-label">Brand Color</label>
            <div class="color-picker" data-prefix="main" data-default="#0b343d">
              <div class="color-header">
                <div class="color-preview-wrap">
                  <div class="color-preview" data-role="preview"></div>
                  <input type="text" class="color-hex" data-role="hex" value="#0b343d" aria-label="Brand color hex">
                </div>
                <input type="hidden" name="main_color" data-role="value" value="#0b343d">
              </div>
              <div class="slider-label"><span>Hue</span><span data-role="hue-value">0</span></div>
              <input type="range" min="0" max="360" value="200" class="color-slider" data-role="hue">
              <div class="slider-label"><span>Saturation</span><span data-role="sat-value">70</span></div>
              <input type="range" min="0" max="100" value="70" class="color-slider" data-role="sat">
              <div class="slider-label"><span>Lightness</span><span data-role="light-value">40</span></div>
              <input type="range" min="0" max="100" value="40" class="color-slider" data-role="light">
              <div class="color-swatches" data-role="swatches"></div>
            </div>
          </div>
          <div class="col-6">
            <label class="form-label">Accent Color</label>
            <div class="color-picker" data-prefix="sub" data-default="#ffc832">
              <div class="color-header">
                <div class="color-preview-wrap">
                  <div class="color-preview" data-role="preview"></div>
                  <input type="text" class="color-hex" data-role="hex" value="#ffc832" aria-label="Accent color hex">
                </div>
                <input type="hidden" name="sub_color" data-role="value" value="#ffc832">
              </div>
              <div class="slider-label"><span>Hue</span><span data-role="hue-value">50</span></div>
              <input type="range" min="0" max="360" value="50" class="color-slider" data-role="hue">
              <div class="slider-label"><span>Saturation</span><span data-role="sat-value">90</span></div>
              <input type="range" min="0" max="100" value="90" class="color-slider" data-role="sat">
              <div class="slider-label"><span>Lightness</span><span data-role="light-value">60</span></div>
              <input type="range" min="0" max="100" value="60" class="color-slider" data-role="light">
              <div class="color-swatches" data-role="swatches"></div>
            </div>
          </div>
        </div>
        <button type="submit" class="btn w-100 py-3 text-white fw-bold" style="background: var(--brand-dark); border-radius:12px;">
          Send OTP
        </button>
      </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  function nextStep(step) {
    document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.step-dot').forEach(el => el.classList.remove('active'));
    document.getElementById('step-' + step).classList.add('active');
    for(let i=1; i<=step; i++) document.getElementById('dot-' + i).classList.add('active');
    
    const titles = ["Account Security", "Restaurant Branding", "Final Details"];
    document.getElementById('step-text').innerText = "Step " + step + ": " + titles[step-1];
  }

  function clamp(value, min, max) {
    return Math.min(Math.max(value, min), max);
  }

  function toHex(value) {
    const hex = value.toString(16);
    return hex.length === 1 ? '0' + hex : hex;
  }

  function hslToHex(h, s, l) {
    const sat = s / 100;
    const light = l / 100;
    const c = (1 - Math.abs(2 * light - 1)) * sat;
    const x = c * (1 - Math.abs((h / 60) % 2 - 1));
    const m = light - c / 2;
    let r = 0;
    let g = 0;
    let b = 0;

    if (h >= 0 && h < 60) { r = c; g = x; b = 0; }
    else if (h >= 60 && h < 120) { r = x; g = c; b = 0; }
    else if (h >= 120 && h < 180) { r = 0; g = c; b = x; }
    else if (h >= 180 && h < 240) { r = 0; g = x; b = c; }
    else if (h >= 240 && h < 300) { r = x; g = 0; b = c; }
    else { r = c; g = 0; b = x; }

    const r255 = Math.round((r + m) * 255);
    const g255 = Math.round((g + m) * 255);
    const b255 = Math.round((b + m) * 255);
    return '#' + toHex(r255) + toHex(g255) + toHex(b255);
  }

  function hexToRgb(hex) {
    const clean = hex.replace('#', '');
    if (clean.length !== 6) return null;
    return {
      r: parseInt(clean.slice(0, 2), 16),
      g: parseInt(clean.slice(2, 4), 16),
      b: parseInt(clean.slice(4, 6), 16)
    };
  }

  function rgbToHsl(r, g, b) {
    const rN = r / 255;
    const gN = g / 255;
    const bN = b / 255;
    const max = Math.max(rN, gN, bN);
    const min = Math.min(rN, gN, bN);
    let h = 0;
    let s = 0;
    const l = (max + min) / 2;

    if (max !== min) {
      const d = max - min;
      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
      switch (max) {
        case rN:
          h = (gN - bN) / d + (gN < bN ? 6 : 0);
          break;
        case gN:
          h = (bN - rN) / d + 2;
          break;
        default:
          h = (rN - gN) / d + 4;
      }
      h *= 60;
    }
    return { h: Math.round(h), s: Math.round(s * 100), l: Math.round(l * 100) };
  }

  function normalizeHex(value) {
    if (!value) return null;
    let clean = value.trim().toLowerCase();
    if (clean[0] !== '#') clean = '#' + clean;
    if (!/^#[0-9a-f]{6}$/.test(clean)) return null;
    return clean;
  }

  function buildSwatches(container, onPick) {
    const palette = [
      '#0b343d', '#1f4a50', '#2f5f63', '#3b7474', '#4e8a7a',
      '#ffc832', '#f2b950', '#e6a667', '#d08b63', '#b86f5e',
      '#2f2f3a', '#3f4b60', '#4b5f7c', '#5c7395', '#6f88ad',
      '#7a3b4b', '#8f4b5b', '#a95b6b', '#c16b7b', '#d87f8f',
      '#1f3b2c', '#2c4f38', '#3b6344', '#4a7751', '#5c8c5f',
      '#3a2f2f', '#4d3a33', '#60463a', '#745243', '#8a6050'
    ];
    palette.forEach(color => {
      const swatch = document.createElement('div');
      swatch.className = 'swatch';
      swatch.style.background = color;
      swatch.setAttribute('data-color', color);
      swatch.addEventListener('click', () => onPick(color, swatch));
      container.appendChild(swatch);
    });
  }

  function initPicker(picker) {
    const preview = picker.querySelector('[data-role="preview"]');
    const hexInput = picker.querySelector('[data-role="hex"]');
    const valueInput = picker.querySelector('[data-role="value"]');
    const hue = picker.querySelector('[data-role="hue"]');
    const sat = picker.querySelector('[data-role="sat"]');
    const light = picker.querySelector('[data-role="light"]');
    const hueValue = picker.querySelector('[data-role="hue-value"]');
    const satValue = picker.querySelector('[data-role="sat-value"]');
    const lightValue = picker.querySelector('[data-role="light-value"]');
    const swatches = picker.querySelector('[data-role="swatches"]');
    const defaultHex = normalizeHex(picker.getAttribute('data-default')) || '#0b343d';

    const applyHex = (hex) => {
      preview.style.background = hex;
      hexInput.value = hex;
      valueInput.value = hex;
      const rgb = hexToRgb(hex);
      if (rgb) {
        const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
        hue.value = hsl.h;
        sat.value = hsl.s;
        light.value = hsl.l;
        hueValue.textContent = hsl.h;
        satValue.textContent = hsl.s;
        lightValue.textContent = hsl.l;
      }
      swatches.querySelectorAll('.swatch').forEach(s => s.classList.remove('active'));
      const match = swatches.querySelector('[data-color="' + hex + '"]');
      if (match) match.classList.add('active');
    };

    const updateFromSliders = () => {
      const h = clamp(parseInt(hue.value, 10) || 0, 0, 360);
      const s = clamp(parseInt(sat.value, 10) || 0, 0, 100);
      const l = clamp(parseInt(light.value, 10) || 0, 0, 100);
      hueValue.textContent = h;
      satValue.textContent = s;
      lightValue.textContent = l;
      applyHex(hslToHex(h, s, l));
    };

    buildSwatches(swatches, (hex, swatch) => {
      applyHex(hex);
      swatches.querySelectorAll('.swatch').forEach(s => s.classList.remove('active'));
      swatch.classList.add('active');
    });

    hue.addEventListener('input', updateFromSliders);
    sat.addEventListener('input', updateFromSliders);
    light.addEventListener('input', updateFromSliders);
    hexInput.addEventListener('change', () => {
      const normalized = normalizeHex(hexInput.value);
      if (normalized) applyHex(normalized);
      else hexInput.value = valueInput.value;
    });

    applyHex(defaultHex);
  }

  document.querySelectorAll('.color-picker').forEach(initPicker);
</script>
{% endblock %}