{% extends 'base/base.html' %}

{% block title %}Settings — Resto Admin{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid px-4" >
    <div class="page-header">
        <div>
            <h2 class="page-title">Settings</h2>
            <p class="page-subtitle">Manage branding, hours, and notifications.</p>
        </div>
        <button class="page-action-btn" type="button" onclick="document.getElementById('saveSettingsBtn').click()">Save Changes</button>
    </div>

    <form method="post" enctype="multipart/form-data" id="settingsForm">
    <div class="settings-section is-collapsed" data-collapsible>
        <div class="section-header">
            <h5>Business & Branding</h5>
            <button type="button" class="section-toggle" data-section-toggle>Show</button>
        </div>
        <div class="section-body">
        <h6 class="text-uppercase text-muted" style="font-size:0.75rem; letter-spacing:0.08em;">Branding & Display</h6>
        <div class="editable-item mb-3" data-empty="Not set">
            <div class="editable-header">
                <label for="establishment_name" class="form-label">Establishment Name</label>
                <button type="button" class="edit-btn" data-edit>Edit</button>
            </div>
            <div class="display-value" data-display>{{ cfg.get('establishment_name','') }}</div>
            <input id="establishment_name" name="establishment_name" type="text" class="form-control editable-input" data-input placeholder="Your restaurant name" value="{{ cfg.get('establishment_name','') }}" disabled>
        </div>

        <div class="editable-item mb-3" data-empty="Not set">
            <div class="editable-header">
                <label for="logo_url" class="form-label">Logo</label>
                <button type="button" class="edit-btn" data-edit>Edit</button>
            </div>
            <div class="display-value" data-display>{{ cfg.get('logo_url','') }}</div>
            <div class="d-flex align-items-center editable-input" data-input-group style="gap:12px;">
                <input id="logo_url" name="logo_url" type="text" class="form-control editable-input" data-input placeholder="https://example.com/logo.png" value="{{ cfg.get('logo_url','') }}" disabled>
                <label class="btn btn-outline-secondary mb-0" style="padding:6px 10px; position:relative; overflow:hidden;">
                    Upload
                    <input id="logo_file" name="logo_file" type="file" accept="image/*" style="position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer;" />
                </label>
                <span id="logo_filename" style="font-size:.9rem;color:#555;">&nbsp;</span>
            </div>
            <div class="mt-2 d-flex align-items-center" style="gap:12px;">
                <img id="logo_preview" src="{{ cfg.get('logo_url','') }}" alt="Logo" style="width:48px;height:48px;border-radius:8px;border:1px solid var(--border);object-fit:contain;background:#f5f5f5;padding:4px;" onerror="this.style.display='none'">
                <small class="text-muted">Preview (changes show after Save)</small>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-6">
                <label for="main_color_picker" class="form-label">Main Color</label>
                <div class="color-picker is-collapsed" data-collapsible>
                    <div class="color-picker-header">
                        <span class="color-picker-title">Palette & Sliders</span>
                        <button type="button" class="section-toggle" data-color-toggle>Show</button>
                    </div>
                    <div class="color-picker-body" data-default="{{ cfg.get('main_color', cfg.get('color_hex','#1e40af')) }}">
                    <div class="color-header">
                        <div class="color-preview-wrap">
                            <div class="color-preview" data-role="preview"></div>
                            <input id="main_color_hex" class="color-hex" data-role="hex" value="{{ cfg.get('main_color', cfg.get('color_hex','#1e40af')) }}" aria-label="Main color hex">
                        </div>
                        <input id="main_color" name="main_color" type="hidden" data-role="value" value="{{ cfg.get('main_color', cfg.get('color_hex','#1e40af')) }}">
                    </div>
                    <div class="slider-label"><span>Hue</span><span data-role="hue-value">0</span></div>
                    <input type="range" min="0" max="360" value="200" class="color-slider" data-role="hue">
                    <div class="slider-label"><span>Saturation</span><span data-role="sat-value">70</span></div>
                    <input type="range" min="0" max="100" value="70" class="color-slider" data-role="sat">
                    <div class="slider-label"><span>Lightness</span><span data-role="light-value">40</span></div>
                    <input type="range" min="0" max="100" value="40" class="color-slider" data-role="light">
                    <div class="color-swatches" data-role="swatches"></div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <label for="sub_color_picker" class="form-label">Accent / Sub Color</label>
                <div class="color-picker is-collapsed" data-collapsible>
                    <div class="color-picker-header">
                        <span class="color-picker-title">Palette & Sliders</span>
                        <button type="button" class="section-toggle" data-color-toggle>Show</button>
                    </div>
                    <div class="color-picker-body" data-default="{{ cfg.get('sub_color', '#ffd41d') }}">
                    <div class="color-header">
                        <div class="color-preview-wrap">
                            <div class="color-preview" data-role="preview"></div>
                            <input id="sub_color_hex" class="color-hex" data-role="hex" value="{{ cfg.get('sub_color', '#ffd41d') }}" aria-label="Accent color hex">
                        </div>
                        <input id="sub_color" name="sub_color" type="hidden" data-role="value" value="{{ cfg.get('sub_color', '#ffd41d') }}">
                    </div>
                    <div class="slider-label"><span>Hue</span><span data-role="hue-value">50</span></div>
                    <input type="range" min="0" max="360" value="50" class="color-slider" data-role="hue">
                    <div class="slider-label"><span>Saturation</span><span data-role="sat-value">90</span></div>
                    <input type="range" min="0" max="100" value="90" class="color-slider" data-role="sat">
                    <div class="slider-label"><span>Lightness</span><span data-role="light-value">60</span></div>
                    <input type="range" min="0" max="100" value="60" class="color-slider" data-role="light">
                    <div class="color-swatches" data-role="swatches"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-12 mt-3">
                <div class="editable-item" data-empty="Default">
                    <div class="editable-header">
                        <label for="font_family" class="form-label">Select Font</label>
                        <button type="button" class="edit-btn" data-edit>Edit</button>
                    </div>
                    <div class="display-value" data-display>{{ cfg.get('font_family','Default') }}</div>
                    <select id="font_family" name="font_family" class="form-select editable-input" data-input disabled>
                        <option value="">-- default --</option>
                        <option value="Arial" {% if cfg.get('font_family','')=='Arial' %}selected{% endif %}>Arial</option>
                        <option value="Helvetica" {% if cfg.get('font_family','')=='Helvetica' %}selected{% endif %}>Helvetica</option>
                        <option value="Roboto" {% if cfg.get('font_family','')=='Roboto' %}selected{% endif %}>Roboto</option>
                        <option value="Georgia" {% if cfg.get('font_family','')=='Georgia' %}selected{% endif %}>Georgia</option>
                    </select>
                </div>
            </div>

            <div class="col-12 mt-3">
                <div class="editable-item" data-empty="Default">
                    <div class="editable-header">
                        <label for="currency_choice" class="form-label">Currency</label>
                        <button type="button" class="edit-btn" data-edit>Edit</button>
                    </div>
                    <div class="display-value" data-display>{{ cfg.get('currency_code','PHP') }} ({{ cfg.get('currency_symbol','₱') }})</div>
                    <select id="currency_choice" name="currency_choice" class="form-select editable-input" data-input disabled>
                        <option value="PHP|₱" {% if cfg.get('currency_code','PHP')=='PHP' %}selected{% endif %}>PHP (₱)</option>
                        <option value="USD|$" {% if cfg.get('currency_code','')=='USD' %}selected{% endif %}>USD ($)</option>
                        <option value="EUR|€" {% if cfg.get('currency_code','')=='EUR' %}selected{% endif %}>EUR (€)</option>
                        <option value="GBP|£" {% if cfg.get('currency_code','')=='GBP' %}selected{% endif %}>GBP (£)</option>
                        <option value="JPY|¥" {% if cfg.get('currency_code','')=='JPY' %}selected{% endif %}>JPY (¥)</option>
                        <option value="AUD|A$" {% if cfg.get('currency_code','')=='AUD' %}selected{% endif %}>AUD (A$)</option>
                        <option value="CAD|C$" {% if cfg.get('currency_code','')=='CAD' %}selected{% endif %}>CAD (C$)</option>
                        <option value="SGD|S$" {% if cfg.get('currency_code','')=='SGD' %}selected{% endif %}>SGD (S$)</option>
                        <option value="INR|₹" {% if cfg.get('currency_code','')=='INR' %}selected{% endif %}>INR (₹)</option>
                    </select>
                </div>
            </div>
        </div>


        <div class="editable-item mb-3" data-empty="Not set">
            <div class="editable-header">
                <label for="chatbot_avatar_url" class="form-label">Chatbot Avatar</label>
                <button type="button" class="edit-btn" data-edit>Edit</button>
            </div>
            <div class="display-value" data-display>{{ cfg.get('chatbot_avatar','/static/img/bot-avatar.svg') }}</div>
            <div class="d-flex align-items-center editable-input" data-input-group style="gap:12px;">
                <input id="chatbot_avatar_url" name="chatbot_avatar_url" type="text" class="form-control editable-input" data-input placeholder="/static/uploads/bot-avatar.svg" value="{{ cfg.get('chatbot_avatar','/static/img/bot-avatar.svg') }}" disabled>
                <label class="btn btn-outline-secondary mb-0" style="padding:6px 10px; position:relative; overflow:hidden;">
                    Upload
                    <input id="chatbot_avatar_file" name="chatbot_avatar_file" type="file" accept="image/*" style="position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer;" />
                </label>
                <span id="chatbot_avatar_filename" style="font-size:.9rem;color:#555;">&nbsp;</span>
            </div>
            <div class="mt-2 d-flex align-items-center" style="gap:12px;">
                <img id="chatbot_avatar_preview" src="{{ cfg.get('chatbot_avatar','/static/img/bot-avatar.svg') }}" alt="Chatbot avatar" style="width:48px;height:48px;border-radius:8px;border:1px solid var(--border);object-fit:cover;">
                <small class="text-muted">Preview (changes show after Save)</small>
            </div>
            <script>
            (function(){
                const fileInput = document.getElementById('chatbot_avatar_file');
                const preview = document.getElementById('chatbot_avatar_preview');
                const filename = document.getElementById('chatbot_avatar_filename');
                const urlInput = document.getElementById('chatbot_avatar_url');

                if(!fileInput) return;
                fileInput.addEventListener('change', function(e){
                    const f = this.files && this.files[0];
                    if(!f){
                        filename.textContent = '';
                        return;
                    }
                    filename.textContent = f.name;
                    // preview via data URL
                    const reader = new FileReader();
                    reader.onload = function(ev){
                        preview.src = ev.target.result;
                    };
                    reader.readAsDataURL(f);

                    // clear URL input so backend prefers uploaded file
                    urlInput.value = '';
                });
            })();
            </script>
        </div>

        </div>
    </div>

    <div class="settings-section is-collapsed" data-collapsible>
        <div class="section-header">
            <h5>Notifications & Alerts</h5>
            <button type="button" class="section-toggle" data-section-toggle>Show</button>
        </div>
        <div class="section-body">
        <div class="setting-row">
            <span class="setting-label">Email Notifications on New Orders</span>
            <div class="toggle-switch active" onclick="this.classList.toggle('active')">
                <div class="toggle-slider"></div>
            </div>
        </div>
        <div class="setting-row">
            <span class="setting-label">SMS Alerts for Critical Issues</span>
            <div class="toggle-switch" onclick="this.classList.toggle('active')">
                <div class="toggle-slider"></div>
            </div>
        </div>
        <div class="setting-row">
            <span class="setting-label">Daily Sales Summary Email</span>
            <div class="toggle-switch active" onclick="this.classList.toggle('active')">
                <div class="toggle-slider"></div>
            </div>
        </div>
        <div class="setting-row">
            <span class="setting-label">Inventory Low Stock Alerts</span>
            <div class="toggle-switch active" onclick="this.classList.toggle('active')">
                <div class="toggle-slider"></div>
            </div>
        </div>
        </div>
    </div>

    <div class="settings-section is-collapsed" data-collapsible>
        <div class="section-header">
            <h5>Operating Hours</h5>
            <button type="button" class="section-toggle" data-section-toggle>Show</button>
        </div>
        <div class="section-body">
        <div class="row">
            <div class="col-md-6">
                <div class="editable-item mb-3" data-empty="Not set">
                    <div class="editable-header">
                        <label for="open_time" class="form-label">Opening Time</label>
                        <button type="button" class="edit-btn" data-edit>Edit</button>
                    </div>
                    <div class="display-value" data-display>{{ cfg.get('open_time','10:00') }}</div>
                    <input name="open_time" type="time" id="open_time" class="form-control editable-input" data-input value="{{ cfg.get('open_time','10:00') }}" disabled />
                </div>
            </div>
            <div class="col-md-6">
                <div class="editable-item mb-3" data-empty="Not set">
                    <div class="editable-header">
                        <label for="close_time" class="form-label">Closing Time</label>
                        <button type="button" class="edit-btn" data-edit>Edit</button>
                    </div>
                    <div class="display-value" data-display>{{ cfg.get('close_time','22:00') }}</div>
                    <input name="close_time" type="time" id="close_time" class="form-control editable-input" data-input value="{{ cfg.get('close_time','22:00') }}" disabled />
                </div>
            </div>
        </div>
        <div class="setting-row">
            <span class="setting-label">Enable Online Ordering</span>
            <div class="toggle-switch active" onclick="this.classList.toggle('active')">
                <div class="toggle-slider"></div>
            </div>
        </div>
        <div class="setting-row">
            <span class="setting-label">Enable Delivery</span>
            <div class="toggle-switch active" onclick="this.classList.toggle('active')">
                <div class="toggle-slider"></div>
            </div>
        </div>
        </div>
    </div>

    <div class="settings-section is-collapsed" data-collapsible>
        <div class="section-header">
            <h5>Payment Settings</h5>
            <button type="button" class="section-toggle" data-section-toggle>Show</button>
        </div>
        <div class="section-body">
        <div class="setting-row">
            <span class="setting-label">Credit Card Payments</span>
            <div class="toggle-switch active" onclick="this.classList.toggle('active')">
                <div class="toggle-slider"></div>
            </div>
        </div>
        <div class="setting-row">
            <span class="setting-label">Digital Wallet (Apple Pay, Google Pay)</span>
            <div class="toggle-switch active" onclick="this.classList.toggle('active')">
                <div class="toggle-slider"></div>
            </div>
        </div>
        <div class="setting-row">
            <span class="setting-label">Cash Payments</span>
            <div class="toggle-switch active" onclick="this.classList.toggle('active')">
                <div class="toggle-slider"></div>
            </div>
        </div>
        <div class="editable-item mb-3" data-empty="Not set">
            <div class="editable-header">
                <label for="tax_rate" class="form-label">Tax Rate (%)</label>
                <button type="button" class="edit-btn" data-edit>Edit</button>
            </div>
            <div class="display-value" data-display>{{ cfg.get('tax_rate',8.5) }}</div>
            <input name="tax_rate" type="number" id="tax_rate" class="form-control editable-input" data-input value="{{ cfg.get('tax_rate',8.5) }}" step="0.1" disabled />
        </div>
        </div>
    </div>

    <div class="settings-section is-collapsed" data-collapsible>
        <div class="section-header">
            <h5>Security & Privacy</h5>
            <button type="button" class="section-toggle" data-section-toggle>Show</button>
        </div>
        <div class="section-body">
        <div class="setting-row">
            <span class="setting-label">Two-Factor Authentication</span>
            <div class="toggle-switch" onclick="this.classList.toggle('active')">
                <div class="toggle-slider"></div>
            </div>
        </div>
        <div class="editable-item mb-3" data-empty="Not set">
            <div class="editable-header">
                <label for="password" class="form-label">Change Password</label>
                <button type="button" class="edit-btn" data-edit>Edit</button>
            </div>
            <div class="display-value" data-display>Hidden</div>
            <input type="password" id="password" class="form-control editable-input" data-input placeholder="Enter new password" disabled />
        </div>
        <div class="editable-item mb-3" data-empty="Not set">
            <div class="editable-header">
                <label for="confirm_password" class="form-label">Confirm Password</label>
                <button type="button" class="edit-btn" data-edit>Edit</button>
            </div>
            <div class="display-value" data-display>Hidden</div>
            <input type="password" id="confirm_password" class="form-control editable-input" data-input placeholder="Confirm new password" disabled />
        </div>
        </div>
    </div>

        <div class="mb-4">
            <button type="submit" id="saveSettingsBtn" class="btn btn-secondary" style="background:#ff6b6b; border:none; margin-right:10px;">Save Settings</button>
            <button type="button" class="btn btn-outline-secondary" onclick="window.location.reload()">Cancel</button>
            <span id="saveStatus" style="margin-left:12px; color:#666; display:inline-block;"></span>
        </div>

        <!-- Sticky save bar shown when form changes -->
        <div id="stickySaveBar" class="sticky-save-bar" role="region" aria-live="polite">
            <div style="font-weight:600;">Unsaved changes</div>
            <div style="flex:1"></div>
            <button id="stickyCancel" type="button" class="btn btn-cancel">Cancel</button>
            <button id="stickySave" type="button" class="btn btn-save ms-2">Save Settings</button>
        </div>
        </form>
        <script src="{{ url_for('static', filename='js/settings.js') }}"></script>

    <div class="settings-section" style="border-top:2px solid #f0f0f0; padding-top:20px;">
        <h5 style="color:#f44336;">Danger Zone</h5>
        <p style="color:#666; margin-bottom:15px;">These actions cannot be undone. Please proceed with caution.</p>
        <button id="clearMenuBtn" type="button" class="btn btn-outline-danger">Clear Menu Items</button>
        <button class="btn btn-outline-danger">Reset All Settings to Default</button>
        <button class="btn btn-danger ms-2">Delete Account & Data</button>
    </div>
</div>
{% endblock %}
