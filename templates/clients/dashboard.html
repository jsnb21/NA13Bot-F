{% extends 'base/base.html' %}

{% block title %}Dashboard — Resto Admin{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="page-header">
        <div>
            <h2 class="page-title">{{ cfg.get('establishment_name','Resto') }} — Dashboard</h2>
            <p class="page-subtitle">Welcome back! Here's your business overview.</p>
        </div>
        <button class="page-action-btn" type="button">View Insights</button>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card-surface">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div class="dashboard-number" id="totalOrders">-</div>
                        <div class="dashboard-label">Total Orders</div>
                    </div>
                    <div style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-shopping-cart" style="color: var(--primary-light); font-size: 1.4rem;"></i>
                    </div>
                </div>
                    <div class="dashboard-meta">
                    <i class="fas fa-arrow-up"></i> <span id="ordersChange">-</span>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card-surface">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div class="dashboard-number"><span id="totalRevenue">-</span></div>
                        <div class="dashboard-label">Revenue</div>
                    </div>
                    <div style="width: 48px; height: 48px; background: rgba(245, 158, 11, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-dollar-sign" style="color: var(--secondary); font-size: 1.4rem;"></i>
                    </div>
                </div>
                    <div class="dashboard-meta">
                    <i class="fas fa-arrow-up"></i> <span id="revenueChange">-</span>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card-surface">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div class="dashboard-number" id="pendingOrders">-</div>
                        <div class="dashboard-label">Pending Orders</div>
                    </div>
                    <div style="width: 48px; height: 48px; background: rgba(30, 64, 175, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-hourglass-start" style="color: var(--primary); font-size: 1.4rem;"></i>
                    </div>
                </div>
                    <div class="dashboard-meta">
                    <span id="pendingStatus">Loading...</span>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card-surface">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div class="dashboard-number" id="completedOrders">-</div>
                        <div class="dashboard-label">Completed Today</div>
                    </div>
                    <div style="width: 48px; height: 48px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-check-circle" style="color: var(--success); font-size: 1.4rem;"></i>
                    </div>
                </div>
                    <div class="dashboard-meta">
                    <span id="completedStatus">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card-surface">
                <h5 class="mb-5">
                    <i class="fas fa-list" style="margin-right: 8px; color: var(--primary-light);"></i>
                    Recent Orders
                </h5>
                <div style="overflow-x: auto;">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px; color: #9ca3af;">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card-surface">
                <h5 class="mb-3">
                    <i class="fas fa-fire" style="margin-right: 8px; color: var(--secondary);"></i>
                    Top Items
                </h5>
                <div style="padding: 0;" id="topItemsContainer">
                    <div style="text-align: center; padding: 20px; color: #9ca3af;">Loading items...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
window.symbol = '{{ cfg.get("currency_symbol") or "₱" }}';

function formatCurrency(amount) {
    return window.symbol + parseFloat(amount || 0).toFixed(2);
}

function formatTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return diffMins + ' min ago';
    if (diffHours < 24) return diffHours + ' hour' + (diffHours > 1 ? 's' : '') + ' ago';
    return diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';
}

function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge bg-warning text-dark">Pending</span>',
        'confirmed': '<span class="badge bg-info">Confirmed</span>',
        'in_progress': '<span class="badge" style="background: var(--secondary);">In Progress</span>',
        'completed': '<span class="badge bg-success">Completed</span>',
        'cancelled': '<span class="badge bg-danger">Cancelled</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">' + status + '</span>';
}

async function loadDashboardData() {
    // Safety check: only run if dashboard page is still loaded
    if (!document.getElementById('totalOrders')) return;
    
    try {
        const response = await fetch('/api/orders/list');
        if (!response.ok) throw new Error('Failed to fetch orders');
        const data = await response.json();
        const orders = data.orders || [];
        
        // Calculate stats
        const totalOrders = orders.length;
        const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.total_amount) || 0), 0);
        const pendingCount = orders.filter(o => o.status === 'pending').length;
        const completedCount = orders.filter(o => o.status === 'completed').length;
        
        // Update stats cards (with null checks)
        const el = (id) => document.getElementById(id);
        if (el('totalOrders')) el('totalOrders').textContent = totalOrders;
        if (el('totalRevenue')) el('totalRevenue').textContent = formatCurrency(totalRevenue);
        if (el('pendingOrders')) el('pendingOrders').textContent = pendingCount;
        if (el('completedOrders')) el('completedOrders').textContent = completedCount;
        if (el('pendingStatus')) el('pendingStatus').textContent = pendingCount + ' awaiting processing';
        if (el('completedStatus')) el('completedStatus').textContent = completedCount + ' completed today';
        
        // Estimate percentage change (mock calculation)
        const percent = Math.floor(Math.random() * 15) + 1;
        if (el('ordersChange')) el('ordersChange').textContent = percent + '% from yesterday';
        if (el('revenueChange')) el('revenueChange').textContent = Math.floor(Math.random() * 12) + 1 + '% from yesterday';
        
        // Display recent orders (last 5)
        const recentOrders = orders.slice(0, 5);
        const ordersHtml = recentOrders.length > 0 
            ? recentOrders.map(order => `
                <tr>
                    <td><strong>#${order.id.substring(0, 8).toUpperCase()}</strong></td>
                    <td>${order.customer_name}</td>
                    <td><strong>${formatCurrency(order.total_amount)}</strong></td>
                    <td>${getStatusBadge(order.status)}</td>
                    <td>${formatTime(order.created_at)}</td>
                </tr>
            `).join('')
            : '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #9ca3af;">No orders found</td></tr>';
        
        const recentBody = document.getElementById('recentOrdersBody');
        if (recentBody) recentBody.innerHTML = ordersHtml;
        
        // Calculate and display top items
        const itemStats = {};
        orders.forEach(order => {
            order.items.forEach(item => {
                if (!itemStats[item.name]) {
                    itemStats[item.name] = 0;
                }
                itemStats[item.name] += (item.quantity || 1);
            });
        });
        
        const topItems = Object.entries(itemStats)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 4);
        
        const topItemsHtml = topItems.length > 0
            ? topItems.map((item, idx) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>${item[0]}</span>
                    </div>
                    <span class="top-items-count">${item[1]}</span>
                </div>
            `).join('').slice(0, -101)  // Remove last border-bottom
            : '<div style="text-align: center; padding: 20px; color: #9ca3af;">No items ordered yet</div>';
        
        const topItemsContainer = document.getElementById('topItemsContainer');
        if (topItemsContainer) {
            topItemsContainer.innerHTML = topItemsHtml || '<div style="text-align: center; padding: 20px; color: #9ca3af;">No items ordered yet</div>';
        }
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        const recentOrdersBody = document.getElementById('recentOrdersBody');
        if (recentOrdersBody) {
            recentOrdersBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #dc3545;">Failed to load orders</td></tr>';
        }
    }
}

// Wrap in Turbo event
document.addEventListener('turbo:load', function initDashboard() {
    if (window.dashboardInitialized) return;
    window.dashboardInitialized = true;
    
    loadDashboardData();
    
    // Refresh every minute
    if (window.dashboardRefreshInterval) {
        clearInterval(window.dashboardRefreshInterval);
    }
    window.dashboardRefreshInterval = setInterval(loadDashboardData, 60000);
});
</script>
{% endblock %}
