{% extends 'base/base.html' %}

{% block title %}Dashboard — Resto Admin{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="page-header">
        <div>
            <h2 class="page-title">{{ cfg.get('establishment_name','Resto') }} — Dashboard</h2>
            <p class="page-subtitle">Welcome back! Here's your business overview.</p>
        </div>
        <button class="page-action-btn" type="button" id="viewInsightsBtn">View Insights</button>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card-surface">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div class="dashboard-number" id="totalOrders">-</div>
                        <div class="dashboard-label">Total Orders</div>
                    </div>
                    <div style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-shopping-cart" style="color: var(--primary-light); font-size: 1.4rem;"></i>
                    </div>
                </div>
                    <div class="dashboard-meta">
                    <i class="fas fa-arrow-up"></i> <span id="ordersChange">-</span>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card-surface">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div class="dashboard-number"><span id="totalRevenue">-</span></div>
                        <div class="dashboard-label">Revenue</div>
                    </div>
                    <div style="width: 48px; height: 48px; background: rgba(245, 158, 11, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-dollar-sign" style="color: var(--secondary); font-size: 1.4rem;"></i>
                    </div>
                </div>
                    <div class="dashboard-meta">
                    <i class="fas fa-arrow-up"></i> <span id="revenueChange">-</span>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card-surface">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div class="dashboard-number" id="pendingOrders">-</div>
                        <div class="dashboard-label">Pending Orders</div>
                    </div>
                    <div style="width: 48px; height: 48px; background: rgba(30, 64, 175, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-hourglass-start" style="color: var(--primary); font-size: 1.4rem;"></i>
                    </div>
                </div>
                    <div class="dashboard-meta">
                    <span id="pendingStatus">Loading...</span>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card-surface">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div class="dashboard-number" id="completedOrders">-</div>
                        <div class="dashboard-label">Completed Today</div>
                    </div>
                    <div style="width: 48px; height: 48px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-check-circle" style="color: var(--success); font-size: 1.4rem;"></i>
                    </div>
                </div>
                    <div class="dashboard-meta">
                    <span id="completedStatus">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card-surface">
                <h5 class="mb-5">
                    <i class="fas fa-list" style="margin-right: 8px; color: var(--primary-light);"></i>
                    Recent Orders
                </h5>
                <div style="overflow-x: auto;">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px; color: #9ca3af;">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card-surface">
                <h5 class="mb-3">
                    <i class="fas fa-fire" style="margin-right: 8px; color: var(--secondary);"></i>
                    Top Items
                </h5>
                <div style="padding: 0;" id="topItemsContainer">
                    <div style="text-align: center; padding: 20px; color: #9ca3af;">Loading items...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Insights Modal -->
<div class="modal fade" id="insightsModal" tabindex="-1" aria-labelledby="insightsModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="insightsModalTitle">Business Insights</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <div style="padding: 15px; background: #f0f9ff; border-radius: 10px; margin-bottom: 15px;">
              <small style="color: #666; display: block; margin-bottom: 5px;">Today's Revenue</small>
              <div style="font-size: 1.8rem; font-weight: 700; color: #1e40af;" id="insightsTodayRevenue">-</div>
            </div>
            <div style="padding: 15px; background: #fef2f2; border-radius: 10px;">
              <small style="color: #666; display: block; margin-bottom: 5px;">Average Order Value</small>
              <div style="font-size: 1.8rem; font-weight: 700; color: #dc3545;" id="insightsAOV">-</div>
            </div>
          </div>
          <div class="col-md-6">
            <div style="padding: 15px; background: #ecfdf5; border-radius: 10px; margin-bottom: 15px;">
              <small style="color: #666; display: block; margin-bottom: 5px;">Orders Today</small>
              <div style="font-size: 1.8rem; font-weight: 700; color: #059669;" id="insightsTodayOrders">-</div>
            </div>
            <div style="padding: 15px; background: #fffbeb; border-radius: 10px;">
              <small style="color: #666; display: block; margin-bottom: 5px;">Best Selling Item</small>
              <div style="font-size: 1.4rem; font-weight: 700; color: #b45309;" id="insightsBestItem">-</div>
            </div>
          </div>
        </div>
        <hr>
        <div class="mt-4">
          <h6 style="margin-bottom: 15px;">Order Status Breakdown</h6>
          <div id="insightsStatusBreakdown" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
            <div style="padding: 12px; background: #e0e7ff; border-radius: 8px; text-align: center;">
              <div style="font-size: 2rem; font-weight: 700; color: #4f46e5;" id="statusPending">-</div>
              <small style="color: #666;">Pending</small>
            </div>
            <div style="padding: 12px; background: #dbeafe; border-radius: 8px; text-align: center;">
              <div style="font-size: 2rem; font-weight: 700; color: #0ea5e9;" id="statusConfirmed">-</div>
              <small style="color: #666;">Confirmed</small>
            </div>
            <div style="padding: 12px; background: #dcfce7; border-radius: 8px; text-align: center;">
              <div style="font-size: 2rem; font-weight: 700; color: #16a34a;" id="statusCompleted">-</div>
              <small style="color: #666;">Completed</small>
            </div>
            <div style="padding: 12px; background: #fee2e2; border-radius: 8px; text-align: center;">
              <div style="font-size: 2rem; font-weight: 700; color: #dc2626;" id="statusCancelled">-</div>
              <small style="color: #666;">Cancelled</small>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
window.symbol = '{{ cfg.get("currency_symbol") or "₱" }}';

function formatCurrency(amount) {
    return window.symbol + parseFloat(amount || 0).toFixed(2);
}

function formatTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return diffMins + ' min ago';
    if (diffHours < 24) return diffHours + ' hour' + (diffHours > 1 ? 's' : '') + ' ago';
    return diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';
}

function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge bg-warning text-dark">Pending</span>',
        'confirmed': '<span class="badge bg-info">Confirmed</span>',
        'in_progress': '<span class="badge" style="background: var(--secondary);">In Progress</span>',
        'completed': '<span class="badge bg-success">Completed</span>',
        'cancelled': '<span class="badge bg-danger">Cancelled</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">' + status + '</span>';
}

async function loadDashboardData() {
    // Safety check: only run if dashboard page is still loaded
    if (!document.getElementById('totalOrders')) return;
    
    try {
        const response = await fetch('/api/orders/list');
        if (!response.ok) throw new Error('Failed to fetch orders');
        const data = await response.json();
        const orders = data.orders || [];
        
        // Calculate stats
        const totalOrders = orders.length;
        const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.total_amount) || 0), 0);
        const pendingCount = orders.filter(o => o.status === 'pending').length;
        const completedCount = orders.filter(o => o.status === 'completed').length;
        
        // Update stats cards (with null checks)
        const el = (id) => document.getElementById(id);
        if (el('totalOrders')) el('totalOrders').textContent = totalOrders;
        if (el('totalRevenue')) el('totalRevenue').textContent = formatCurrency(totalRevenue);
        if (el('pendingOrders')) el('pendingOrders').textContent = pendingCount;
        if (el('completedOrders')) el('completedOrders').textContent = completedCount;
        if (el('pendingStatus')) el('pendingStatus').textContent = pendingCount + ' awaiting processing';
        if (el('completedStatus')) el('completedStatus').textContent = completedCount + ' completed today';
        
        // Estimate percentage change (mock calculation)
        const percent = Math.floor(Math.random() * 15) + 1;
        if (el('ordersChange')) el('ordersChange').textContent = percent + '% from yesterday';
        if (el('revenueChange')) el('revenueChange').textContent = Math.floor(Math.random() * 12) + 1 + '% from yesterday';
        
        // Display recent orders (last 5)
        const recentOrders = orders.slice(0, 5);
        const ordersHtml = recentOrders.length > 0 
            ? recentOrders.map(order => `
                <tr>
                    <td><strong>#${order.id.substring(0, 8).toUpperCase()}</strong></td>
                    <td>${order.customer_name}</td>
                    <td><strong>${formatCurrency(order.total_amount)}</strong></td>
                    <td>${getStatusBadge(order.status)}</td>
                    <td>${formatTime(order.created_at)}</td>
                </tr>
            `).join('')
            : '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #9ca3af;">No orders found</td></tr>';
        
        const recentBody = document.getElementById('recentOrdersBody');
        if (recentBody) recentBody.innerHTML = ordersHtml;
        
        // Calculate and display top items
        const itemStats = {};
        orders.forEach(order => {
            order.items.forEach(item => {
                if (!itemStats[item.name]) {
                    itemStats[item.name] = 0;
                }
                itemStats[item.name] += (item.quantity || 1);
            });
        });
        
        const topItems = Object.entries(itemStats)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 4);
        
        const topItemsHtml = topItems.length > 0
            ? topItems.map((item, idx) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>${item[0]}</span>
                    </div>
                    <span class="top-items-count">${item[1]}</span>
                </div>
            `).join('').slice(0, -101)  // Remove last border-bottom
            : '<div style="text-align: center; padding: 20px; color: #9ca3af;">No items ordered yet</div>';
        
        const topItemsContainer = document.getElementById('topItemsContainer');
        if (topItemsContainer) {
            topItemsContainer.innerHTML = topItemsHtml || '<div style="text-align: center; padding: 20px; color: #9ca3af;">No items ordered yet</div>';
        }
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        const recentOrdersBody = document.getElementById('recentOrdersBody');
        if (recentOrdersBody) {
            recentOrdersBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #dc3545;">Failed to load orders</td></tr>';
        }
    }
}

// View Insights handler
function showInsights(orders) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const todayOrders = orders.filter(o => {
        const oDate = new Date(o.created_at);
        oDate.setHours(0, 0, 0, 0);
        return oDate.getTime() === today.getTime();
    });
    
    // Calculate metrics
    const todayRevenue = todayOrders.reduce((sum, o) => sum + (o.total_amount || 0), 0);
    const todayOrderCount = todayOrders.length;
    const aov = todayOrderCount > 0 ? todayRevenue / todayOrderCount : 0;
    
    // Best selling item
    const itemStats = {};
    orders.forEach(order => {
        order.items.forEach(item => {
            itemStats[item.name] = (itemStats[item.name] || 0) + (item.quantity || 1);
        });
    });
    const bestItem = Object.entries(itemStats).sort((a, b) => b[1] - a[1])[0] || ['N/A', 0];
    
    // Status breakdown
    const statusCount = {
        pending: orders.filter(o => o.status === 'pending').length,
        confirmed: orders.filter(o => o.status === 'confirmed').length,
        completed: orders.filter(o => o.status === 'completed').length,
        cancelled: orders.filter(o => o.status === 'cancelled').length
    };
    
    // Update modal
    document.getElementById('insightsTodayRevenue').textContent = formatCurrency(todayRevenue);
    document.getElementById('insightsTodayOrders').textContent = todayOrderCount;
    document.getElementById('insightsAOV').textContent = formatCurrency(aov);
    document.getElementById('insightsBestItem').textContent = bestItem[0];
    document.getElementById('statusPending').textContent = statusCount.pending;
    document.getElementById('statusConfirmed').textContent = statusCount.confirmed;
    document.getElementById('statusCompleted').textContent = statusCount.completed;
    document.getElementById('statusCancelled').textContent = statusCount.cancelled;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('insightsModal'));
    modal.show();
}

// Wrap in Turbo event
document.addEventListener('turbo:load', function initDashboard() {
    if (window.dashboardInitialized) return;
    window.dashboardInitialized = true;
    
    loadDashboardData();
    
    // View Insights button handler
    const viewInsightsBtn = document.getElementById('viewInsightsBtn');
    if (viewInsightsBtn) {
        viewInsightsBtn.addEventListener('click', async () => {
            try {
                const res = await fetch('/api/orders/list');
                if (!res.ok) throw new Error('Failed to fetch orders');
                const data = await res.json();
                const orders = data.orders || [];
                showInsights(orders);
            } catch (error) {
                console.error('Error fetching orders for insights:', error);
                alert('Failed to load insights');
            }
        });
    }
    
    // Refresh every minute
    if (window.dashboardRefreshInterval) {
        clearInterval(window.dashboardRefreshInterval);
    }
    window.dashboardRefreshInterval = setInterval(loadDashboardData, 60000);
});
</script>
{% endblock %}
